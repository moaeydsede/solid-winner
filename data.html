<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تسجيل البيانات | Financial Analytics SUITE</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<header class="topbar">
  <div class="brand">
    <button id="btnMenu" class="btn icon" title="القائمة">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <div class="logo">FA</div>
    <div>
      <div class="title">تسجيل البيانات</div>
      <div class="subtitle">CRUD + Import/Export + Validation</div>
    </div>
  </div>
  <div class="actions">
    <span id="userPill" class="pill">مستخدم: <b>—</b></span>
    <button id="btnLoadSample" class="btn secondary">بيانات تجريبية</button>
    <label class="btn">استيراد
      <input id="fileInput" type="file" accept=".csv,.xlsx,.xls" hidden />
    </label>
    <button id="btnExportXLSX" class="btn secondary">تصدير Excel</button>
    <button id="btnWipe" class="btn danger">مسح</button>
    <button id="btnLogout" class="btn">خروج</button>
  </div>
</header>


<div id="backdrop" class="backdrop"></div>
<aside id="drawer" class="drawer">
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
    <div class="logo" style="width:44px;height:44px;border-radius:16px">FA</div>
    <div>
      <div style="font-weight:950">Financial Analytics SUITE</div>
      <div class="small">PRO • Firebase • Admin Only</div>
    </div>
  </div>

  <div class="sectionTitle">الشاشات</div>
  <nav class="nav">
    <a href="index.html" data-nav="dash"><span>Dashboard</span><span class="hint">KPIs + Alerts</span></a>
    <a href="data.html" data-nav="data"><span>تسجيل البيانات</span><span class="hint">CRUD + Import</span></a>
    <a href="monthly.html" data-nav="monthly"><span>تفريغ شهري</span><span class="hint">Waterfall</span></a>
    <a href="variance.html" data-nav="variance"><span>Variance</span><span class="hint">فترتين + YoY</span></a>
    <a href="ar-ap.html" data-nav="arap"><span>AR/AP</span><span class="hint">Aging + Cohort</span></a>
    <a href="alerts.html" data-nav="alerts"><span>قواعد التنبيهات</span><span class="hint">Rules</span></a>
    <a href="settings.html" data-nav="settings"><span>الإعدادات</span><span class="hint">Balance Inputs</span></a>
  </nav>
</aside>
<script type="module">
  import { wireDrawer } from "./app.js";
  wireDrawer("data");
</script>

<main class="container">
<section class="grid grid2">
  <div class="card">
    <div class="sheetHead">
      <div>
        <div class="title">تسجيل البيانات (Manual Entry)</div>
        <div class="subtitle">إضافة/تعديل/حذف + بحث + تحقق ذكي</div>
      </div>
      <button id="btnNew" class="btn ok">+ إضافة</button>
    </div>
    <hr/>
    <div class="grid grid3">
      <div class="field"><label>بحث</label><input id="q" placeholder="اكتب: نوع/تصنيف/طرف/مرجع..."></div>
      <div class="field"><label>من</label><input id="fromDate" type="date"></div>
      <div class="field"><label>إلى</label><input id="toDate" type="date"></div>
    </div>
    <div class="grid grid4" style="margin-top:10px">
      <div class="field">
        <label>فلتر النوع</label>
        <select id="typeFilter">
          <option value="">الكل</option>
          <option value="sale">sale</option><option value="cogs">cogs</option><option value="expense">expense</option>
          <option value="other_income">other_income</option><option value="other_expense">other_expense</option>
          <option value="tax">tax</option><option value="receipt">receipt</option><option value="payment">payment</option>
          <option value="ar_invoice">ar_invoice</option><option value="ar_payment">ar_payment</option>
          <option value="ap_invoice">ap_invoice</option><option value="ap_payment">ap_payment</option>
        </select>
      </div>
      <div class="field"><label>العملة</label>
        <select id="currency"><option value="EGP">EGP</option><option value="USD">USD</option><option value="SAR">SAR</option><option value="AED">AED</option></select>
      </div>
      <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
        <button id="btnApply" class="btn secondary">تحديث</button>
        <span class="pill">Rows: <b id="rowsCount">—</b></span>
      </div>
    </div>

    <div style="margin-top:12px;overflow:auto">
      <table class="table">
        <thead><tr>
          <th>التاريخ</th><th>type</th><th>amount</th><th>category</th><th>entity</th><th>due</th><th>ref</th><th>إجراء</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="title">ملاحظات الاستيراد/التصدير</div>
    <div class="subtitle">القالب القياسي</div>
    <hr/>
    <div class="small">
      الأعمدة: <b>date,type,amount</b> + (category,entity,due_date,ref).<br/>
      AR/AP invoices تتطلب: <b>entity</b> + <b>due_date</b>.<br/>
      زر الاستيراد موجود بالأعلى، والتصدير Excel يضيف Sheet للبيانات المعروضة.
    </div>
  </div>
</section>

<div id="modal" class="modal">
  <div class="card sheet">
    <div class="sheetHead">
      <div>
        <div class="title" id="modalTitle">إضافة حركة</div>
        <div class="subtitle">حفظ مباشر على Firestore</div>
      </div>
      <button id="btnClose" class="btn">إغلاق</button>
    </div>
    <hr/>
    <div class="grid grid3">
      <div class="field"><label>date</label><input id="f_date" type="date"></div>
      <div class="field"><label>type</label>
        <select id="f_type">
          <option value="sale">sale</option><option value="cogs">cogs</option><option value="expense">expense</option>
          <option value="other_income">other_income</option><option value="other_expense">other_expense</option>
          <option value="tax">tax</option><option value="receipt">receipt</option><option value="payment">payment</option>
          <option value="ar_invoice">ar_invoice</option><option value="ar_payment">ar_payment</option>
          <option value="ap_invoice">ap_invoice</option><option value="ap_payment">ap_payment</option>
        </select>
      </div>
      <div class="field"><label>amount</label><input id="f_amount" type="number" step="0.01"></div>
    </div>
    <div class="grid grid3" style="margin-top:10px">
      <div class="field"><label>category</label><input id="f_category"></div>
      <div class="field"><label>entity</label><input id="f_entity"></div>
      <div class="field"><label>due_date</label><input id="f_due" type="date"></div>
    </div>
    <div class="field" style="margin-top:10px"><label>ref</label><input id="f_ref"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
      <button id="btnSave" class="btn ok">حفظ</button>
      <button id="btnDelete" class="btn danger" style="display:none">حذف</button>
      <span class="small" id="formHint"></span>
    </div>
  </div>
</div>

</main>
<div id="toast" class="toast"></div>

<script type="module">
import { wireDrawer } from "./app.js";
wireDrawer("data");


    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore, collection, doc, getDoc, setDoc, getDocs,
      query, orderBy, where, writeBatch, Timestamp
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";


    import { CFG, $, toast, n, money, computeKPIs, groupByMonth, fmtVar, rangeForPeriod, safeDiv, clamp } from "./app.js";

    const app = initializeApp(CFG.firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    function normalizeRow(row){
      const date = String(row.date ?? row.Date ?? row["التاريخ"] ?? "").trim().slice(0,10);
      const type = String(row.type ?? row.Type ?? row["النوع"] ?? "").trim().toLowerCase();
      const amountRaw = row.amount ?? row.Amount ?? row["المبلغ"];
      const category = String(row.category ?? row.Category ?? row["التصنيف"] ?? "").trim();

      const entity = String(row.entity ?? row.Entity ?? row["الطرف"] ?? row["العميل/المورد"] ?? "").trim();
      const due_date = String(row.due_date ?? row.DueDate ?? row["تاريخ_الاستحقاق"] ?? "").trim().slice(0,10);
      const ref = String(row.ref ?? row.Ref ?? row["مرجع"] ?? "").trim();

      if(!date || !type) return null;
      const allowed = new Set(["sale","cogs","expense","other_income","other_expense","tax","receipt","payment",
        "ar_invoice","ar_payment","ap_invoice","ap_payment"]);
      if(!allowed.has(type)) return null;

      const amount = Number(String(amountRaw ?? "").replace(/,/g,"").trim());
      if(!Number.isFinite(amount)) return null;

      return { date, type, amount, category, entity, due_date, ref };
    }

    async function parseFile(file){
      const name = (file.name||"").toLowerCase();
      if(name.endsWith(".csv")){
        return await new Promise((resolve,reject)=>{
          Papa.parse(file, {
            header:true, skipEmptyLines:true,
            complete: (res)=> {
              const rows=[];
              for(const r of (res.data||[])){ const x=normalizeRow(r); if(x) rows.push(x); }
              resolve(rows);
            },
            error: reject
          });
        });
      }
      if(name.endsWith(".xlsx") || name.endsWith(".xls")){
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, {type:"array"});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {defval:""});
        const rows=[];
        for(const r of json){ const x=normalizeRow(r); if(x) rows.push(x); }
        return rows;
      }
      throw new Error("صيغة غير مدعومة. استخدم CSV أو Excel.");
    }

    async function addTransactions(rows){
      const CHUNK=450;
      for(let i=0;i<rows.length;i+=CHUNK){
        const batch = writeBatch(db);
        const part = rows.slice(i,i+CHUNK);
        for(const r of part){
          const refDoc = doc(collection(db, "transactions"));
          batch.set(refDoc, {
            date: r.date,
            type: r.type,
            amount: n(r.amount),
            category: r.category || "",
            entity: r.entity || "",
            due_date: r.due_date || "",
            ref: r.ref || "",
            createdAt: Timestamp.now()
          });
        }
        await batch.commit();
      }
    }

    async function listTransactions(fromDate, toDate){
      let q1 = query(collection(db,"transactions"), orderBy("date","asc"));
      if(fromDate) q1 = query(collection(db,"transactions"), orderBy("date","asc"), where("date", ">=", fromDate));
      if(toDate) q1 = query(collection(db,"transactions"), orderBy("date","asc"), where("date", "<=", toDate));
      const snap = await getDocs(q1);
      const out=[];
      snap.forEach(d=>out.push({id:d.id, ...d.data()}));
      return out;
    }

    async function wipeAll(){
      const snap = await getDocs(collection(db,"transactions"));
      const ids=[]; snap.forEach(d=>ids.push(d.id));
      const batch = writeBatch(db);
      ids.forEach(id=> batch.delete(doc(db,"transactions", id)));
      await batch.commit();
    }

    async function ensureAdmin(){
      return await new Promise((resolve)=>{
        onAuthStateChanged(auth, async (user)=>{
          if(!user || user.uid !== CFG.ADMIN_UID){
            location.replace("login.html?next="+encodeURIComponent(location.pathname.split("/").pop() || "index.html"));
            resolve(null);
            return;
          }
          $("userPill").innerHTML = "مستخدم: <b>"+(user.email||"admin")+"</b>";
          resolve(user);
        });
      });
    }

    function wireCommonButtons(refreshFn){
      $("btnLogout").addEventListener("click", async ()=>{ await signOut(auth); location.replace("login.html"); });
      $("btnWipe").addEventListener("click", async ()=>{
        if(!confirm("تأكيد: سيتم حذف كل معاملات transactions من Firestore")) return;
        await wipeAll();
        toast("تم المسح");
        await refreshFn();
      });
      $("fileInput").addEventListener("change", async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        try{
          $("fileInput").value="";
          const rows = await parseFile(file);
          if(!rows.length) throw new Error("لا يوجد صفوف صالحة. تأكد من الأعمدة: date,type,amount");
          await addTransactions(rows);
          toast("تم استيراد "+rows.length+" حركة");
          await refreshFn();
        }catch(err){
          console.error(err);
          toast(err?.message || "فشل الاستيراد");
        }
      });
      $("btnLoadSample").addEventListener("click", async ()=>{
        try{
          const csv = `date,type,amount,category,entity,due_date,ref
2025-12-01,sale,18000,مبيعات,,,
2025-12-01,cogs,10400,تكلفة,,,
2025-12-03,expense,1100,رواتب,,,
2025-12-05,expense,500,تسويق,,,
2025-12-06,receipt,15000,تحصيل,,,
2025-12-07,payment,9000,دفع مورد,,,
2026-01-02,sale,20000,مبيعات,,,
2026-01-02,cogs,11800,تكلفة,,,
2026-01-05,expense,1200,رواتب,,,
2026-01-08,expense,650,تسويق,,,
2026-01-15,other_income,600,دخل آخر,,,
2026-01-16,other_expense,350,مصروف آخر,,,
2026-01-20,tax,600,ضريبة,,,
2026-02-01,sale,22000,مبيعات,,,
2026-02-01,cogs,13200,تكلفة,,,
2026-02-03,expense,900,إيجار,,,
2026-02-20,tax,700,ضريبة,,,
2026-01-03,ar_invoice,5000,فاتورة عميل,عميل-أ,2026-02-02,INV-1001
2026-01-18,ar_invoice,6000,فاتورة عميل,عميل-أ,2026-02-18,INV-1002
2026-01-25,ar_invoice,4000,فاتورة عميل,عميل-ب,2026-02-24,INV-2001
2026-02-05,ar_payment,3000,تحصيل عميل,عميل-أ,,PAY-9001
2026-02-22,ar_payment,5000,تحصيل عميل,عميل-أ,,PAY-9002
2026-03-10,ar_payment,2000,تحصيل عميل,عميل-ب,,PAY-9100
2026-01-07,ap_invoice,7000,فاتورة مورد,مورد-س,2026-02-06,BILL-3001
2026-02-10,ap_payment,4000,سداد مورد,مورد-س,,PMT-8001
`;
          const file = new File([csv], "sample_ultraplus.csv", {type:"text/csv"});
          const rows = await parseFile(file);
          await addTransactions(rows);
          toast("تم تحميل بيانات تجريبية ULTRA+");
          await refreshFn();
        }catch(e){ console.error(e); toast("فشل تحميل البيانات التجريبية"); }
      });
      $("btnExportXLSX").addEventListener("click", async ()=>{
        const wb = XLSX.utils.book_new();
        const rows = (window.__rows||[]).map(r=>({
          date:r.date,type:r.type,amount:r.amount,category:r.category||"",entity:r.entity||"",due_date:r.due_date||"",ref:r.ref||""
        }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Transactions");
        if(window.__export && Array.isArray(window.__export.sheets)){
          for(const sh of window.__export.sheets){
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(sh.rows), sh.name);
          }
        }
        XLSX.writeFile(wb, "financial-ultraplus.xlsx");
      });
    }

    window.__api = { listTransactions, computeKPIs, groupByMonth, money, n, fmtVar, rangeForPeriod, safeDiv, clamp };



let editId = null;
const modal = document.getElementById("modal");
const openModal = ()=> modal.classList.add("show");
const closeModal = ()=> modal.classList.remove("show");

function setForm(row){
  document.getElementById("f_date").value = row?.date || new Date().toISOString().slice(0,10);
  document.getElementById("f_type").value = row?.type || "sale";
  document.getElementById("f_amount").value = row?.amount ?? "";
  document.getElementById("f_category").value = row?.category || "";
  document.getElementById("f_entity").value = row?.entity || "";
  document.getElementById("f_due").value = row?.due_date || "";
  document.getElementById("f_ref").value = row?.ref || "";
}

function getForm(){
  return {
    date: document.getElementById("f_date").value,
    type: document.getElementById("f_type").value,
    amount: n(document.getElementById("f_amount").value),
    category: document.getElementById("f_category").value.trim(),
    entity: document.getElementById("f_entity").value.trim(),
    due_date: document.getElementById("f_due").value,
    ref: document.getElementById("f_ref").value.trim(),
  };
}

function validateRow(r){
  if(!r.date) return "التاريخ مطلوب";
  if(!r.type) return "النوع مطلوب";
  if(!Number.isFinite(r.amount)) return "المبلغ غير صحيح";
  if(["ar_invoice","ap_invoice"].includes(r.type)){
    if(!r.entity) return "entity مطلوب لفواتير AR/AP";
    if(!r.due_date) return "due_date مطلوب لفواتير AR/AP";
  }
  return "";
}

function rowWarn(r){
  if(["ar_invoice","ap_invoice"].includes(r.type) && (!r.entity || !r.due_date)) return true;
  return false;
}

function matchQuery(r, q){
  if(!q) return true;
  const t = (r.type||"")+" "+(r.category||"")+" "+(r.entity||"")+" "+(r.ref||"");
  return t.toLowerCase().includes(q.toLowerCase());
}

async function refresh(){
  const fromDate = document.getElementById("fromDate").value || "";
  const toDate = document.getElementById("toDate").value || "";
  const ccy = document.getElementById("currency").value || "EGP";
  const typeFilter = document.getElementById("typeFilter").value || "";
  const q = document.getElementById("q").value.trim();

  const rows = await listTransactions(fromDate, toDate);
  window.__rows = rows;

  const filtered = rows.filter(r=>{
    if(typeFilter && r.type!==typeFilter) return false;
    if(!matchQuery(r,q)) return false;
    return true;
  });

  document.getElementById("rowsCount").textContent = filtered.length;

  document.getElementById("tbody").innerHTML = filtered.slice().reverse().map(r=>`
    <tr style="${rowWarn(r) ? "outline:1px solid rgba(255,205,57,.35)" : ""}">
      <td>${r.date||""}</td>
      <td><span class="badge">${r.type||""}</span></td>
      <td><b>${money(r.amount||0, ccy)}</b></td>
      <td>${r.category||""}</td>
      <td>${r.entity||""}</td>
      <td>${r.due_date||""}</td>
      <td>${r.ref||""}</td>
      <td><button class="btn secondary" data-edit="${r.id}">تعديل</button></td>
    </tr>
  `).join("") || "<tr><td colspan='8' class='small'>لا توجد بيانات</td></tr>";

  window.__export = { sheets: [{name:"Filtered", rows: filtered}] };

  document.querySelectorAll("[data-edit]").forEach(b=>b.addEventListener("click", ()=>{
    const id=b.getAttribute("data-edit");
    const row = rows.find(x=>x.id===id);
    editId = id;
    document.getElementById("modalTitle").textContent = "تعديل حركة";
    document.getElementById("btnDelete").style.display = "inline-block";
    setForm(row);
    document.getElementById("formHint").textContent = "";
    openModal();
  }));
}

document.getElementById("btnApply").addEventListener("click", refresh);
document.getElementById("btnNew").addEventListener("click", ()=>{
  editId=null;
  document.getElementById("modalTitle").textContent = "إضافة حركة";
  document.getElementById("btnDelete").style.display = "none";
  setForm(null);
  document.getElementById("formHint").textContent = "";
  openModal();
});
document.getElementById("btnClose").addEventListener("click", closeModal);
modal.addEventListener("click", (e)=>{ if(e.target===modal) closeModal(); });

document.getElementById("btnSave").addEventListener("click", async ()=>{
  const r = getForm();
  const err = validateRow(r);
  const hint = document.getElementById("formHint");
  if(err){ hint.textContent = err; hint.style.color="var(--warn)"; return; }
  hint.textContent = "جاري الحفظ..."; hint.style.color="var(--muted)";
  if(editId){
    await updateDoc(doc(db,"transactions",editId), {...r, updatedAt: Timestamp.now()});
    toast("تم التعديل");
  }else{
    await setDoc(doc(collection(db,"transactions")), {...r, createdAt: Timestamp.now()});
    toast("تمت الإضافة");
  }
  closeModal();
  await refresh();
});

document.getElementById("btnDelete").addEventListener("click", async ()=>{
  if(!editId) return;
  if(!confirm("تأكيد حذف الحركة؟")) return;
  await deleteDoc(doc(db,"transactions", editId));
  toast("تم الحذف");
  closeModal();
  await refresh();
});

wireCommonButtons(refresh);
await ensureAdmin();
await refresh();

</script>
</body>
</html>
