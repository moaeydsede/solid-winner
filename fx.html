<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="manifest" href="manifest.json" />
  <title>FX Rates | Financial Analytics SUITE</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

<header class="topbar">
  <div class="brand">
    <button id="btnMenu" class="btn icon" title="القائمة">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M4 6h16M4 12h16M4 18h16"/>
      </svg>
    </button>
    <div class="logo">FA</div>
    <div>
      <div class="title">أسعار الصرف</div>
      <div class="subtitle">Multi-currency • Rates to Base Currency</div>
    </div>
  </div>
  <div class="actions">
    <span id="userPill" class="pill">مستخدم: <b>—</b></span>
    <button id="btnLogout" class="btn">خروج</button>
  </div>
</header>

<div id="backdrop" class="backdrop"></div>
<aside id="drawer" class="drawer">
  <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
    <div class="logo" style="width:44px;height:44px;border-radius:16px">FA</div>
    <div>
      <div style="font-weight:950">Financial Analytics SUITE</div>
      <div class="small">PRO+ • Accounting Engine v2</div>
    </div>
  </div>
  <div class="sectionTitle">الشاشات</div>
  <nav class="nav">
    <a href="documents.html" data-nav="docs"><span>المستندات</span><span class="hint">Auto-post</span></a>
    <a href="fx.html" data-nav="fx"><span>أسعار الصرف</span><span class="hint">FX</span></a>
    <a href="period-close.html" data-nav="close"><span>Period Close</span><span class="hint">Lock periods</span></a>
    <a href="cfo.html" data-nav="cfo"><span>CFO Reports</span><span class="hint">P&L / CF / BS</span></a>
    <a href="settings.html" data-nav="settings"><span>الإعدادات</span><span class="hint">Company</span></a>
  </nav>
</aside>

<main class="container">
  <section class="panel">
    <div class="grid grid4">
      <div class="field"><label>Date</label><input id="date" type="date"/></div>
      <div class="field"><label>Currency</label><select id="ccy"><option>USD</option><option>SAR</option><option>AED</option><option>EUR</option></select></div>
      <div class="field"><label>Rate to Base</label><input id="rate" type="number" step="0.000001"/></div>
      <div style="display:flex;gap:10px;align-items:end;flex-wrap:wrap">
        <button id="btnSave" class="btn ok">حفظ</button>
        <button id="btnRefresh" class="btn secondary">تحديث</button>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <div class="title">Recent rates</div>
    <div class="subtitle">آخر 200 سجل</div>
    <div style="overflow:auto;margin-top:10px">
      <table class="table">
        <thead><tr><th>date</th><th>currency</th><th>rateToBase</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script type="module">
  import { wireDrawer, toast } from "./app.js";
  import { requireAuth, logout, companyCol } from "./firebase_client.js";
  import { setFxRate } from "./store.js";
  import { getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  wireDrawer('fx');
  const $=(id)=>document.getElementById(id);
  $('date').value = new Date().toISOString().slice(0,10);

  async function refresh(){
    const snap = await getDocs(query(companyCol('exchangeRates'), orderBy('date','desc'), limit(200)));
    const tb=$('tbody'); tb.innerHTML='';
    for(const d of snap.docs){
      const r=d.data();
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.date||''}</td><td>${r.currency||''}</td><td>${r.rateToBase||''}</td>`;
      tr.addEventListener('click', ()=>{
        $('date').value = r.date||'';
        $('ccy').value = r.currency||'USD';
        $('rate').value = r.rateToBase||'';
      });
      tb.appendChild(tr);
    }
  }

  async function save(){
    const date=$('date').value; const ccy=$('ccy').value; const rate=Number($('rate').value);
    if(!date || !ccy || !Number.isFinite(rate) || rate<=0){ toast('أدخل تاريخ + عملة + سعر صحيح'); return; }
    await setFxRate(date, ccy, rate);
    toast('تم الحفظ');
    await refresh();
  }

  $('btnSave').addEventListener('click', save);
  $('btnRefresh').addEventListener('click', refresh);
  $('btnLogout').addEventListener('click', logout);

  requireAuth(async (user)=>{
    document.querySelector('#userPill b').textContent = user.email || user.uid;
    await refresh();
  });
</script>

<script type="module" src="./pwa.js"></script>
</body>
</html>
